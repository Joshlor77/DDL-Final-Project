#include "NoteOutput.h"
#include "FIO.h"

#define DMACIntStat         (*(volatile unsigned int *) 0x50004000)
#define DMACIntTCStat       (*(volatile unsigned int *) 0x50004004)
#define DMACIntTCClear      (*(volatile unsigned int *) 0x50004008)
#define DMACIntErrStat      (*(volatile unsigned int *) 0x5000400C)
#define DMACIntErrClr       (*(volatile unsigned int *) 0x50004010)
#define DMACRawIntTCStat    (*(volatile unsigned int *) 0x50004014)
#define DMACRawIntErrStat   (*(volatile unsigned int *) 0x50004018)
#define DMACEnbldChns       (*(volatile unsigned int *) 0x5000401C)
#define DMACSoftBReq        (*(volatile unsigned int *) 0x50004020)
#define DMACSoftSReq        (*(volatile unsigned int *) 0x50004024)
#define DMACSoftLBReq       (*(volatile unsigned int *) 0x50004028)
#define DMACSoftLSReq       (*(volatile unsigned int *) 0x5000402C)
#define DMACConfig          (*(volatile unsigned int *) 0x50004030)
#define DMACSync            (*(volatile unsigned int *) 0x50004034)
#define DMAREQSEL           (*(volatile unsigned int *) 0x400FC1C4)

struct DMAChStruct {
    unsigned int SrcAddr;
    unsigned int DestAddr;
    unsigned int LLI;
    unsigned int Control;
    unsigned int Config;
};

#define DMACC0 (*(volatile struct DMAChStruct *) 0x50004100)

typedef struct {
    unsigned int SrcAddr;
    unsigned int DestAddr;
    unsigned int LLI;
    unsigned int Control;
} LLI;

LLI LLI1, LLI2;

/////////////////////////////////////////////////////////////////////

#define PCLK        16000000    // Hz
#define SampleRate  1024      // Hz

#define PCLKSEL0    (*(volatile unsigned int *) 0x400FC1A8)
#define PCONP       (*(volatile unsigned int *) 0x400Fc0C4)

#define DACR        (*(volatile unsigned int *) 0x4008C000)
#define DACCTRL     (*(volatile unsigned int *) 0x4008C004)
#define DACCNTVAL   (*(volatile unsigned int *) 0x4008C008)

/////////////////////////////////////////////////////////////////////

/** Generated using Dr LUT - Free Lookup Table Generator
  * https://github.com/ppelikan/drlut
  **/
// Formula: sin(2*pi*t/T)
unsigned short soundData [1024] = {
   512,   515,   518,   521,   525,   528,   531,
   534,   537,   540,   543,   546,   550,   553,
   556,   559,   562,   565,   568,   571,   575,
   578,   581,   584,   587,   590,   593,   596,
   599,   602,   606,   609,   612,   615,   618,
   621,   624,   627,   630,   633,   636,   639,
   642,   645,   648,   651,   654,   657,   660,
   663,   666,   669,   672,   675,   678,   681,
   684,   687,   690,   693,   696,   699,   702,
   705,   708,   710,   713,   716,   719,   722,
   725,   728,   730,   733,   736,   739,   742,
   745,   747,   750,   753,   756,   758,   761,
   764,   767,   769,   772,   775,   777,   780,
   783,   785,   788,   791,   793,   796,   798,
   801,   804,   806,   809,   811,   814,   816,
   819,   821,   824,   826,   829,   831,   834,
   836,   839,   841,   843,   846,   848,   850,
   853,   855,   857,   860,   862,   864,   867,
   869,   871,   873,   876,   878,   880,   882,
   884,   886,   889,   891,   893,   895,   897,
   899,   901,   903,   905,   907,   909,   911,
   913,   915,   917,   919,   921,   922,   924,
   926,   928,   930,   932,   933,   935,   937,
   939,   940,   942,   944,   945,   947,   949,
   950,   952,   953,   955,   957,   958,   960,
   961,   963,   964,   966,   967,   968,   970,
   971,   973,   974,   975,   977,   978,   979,
   980,   982,   983,   984,   985,   986,   988,
   989,   990,   991,   992,   993,   994,   995,
   996,   997,   998,   999,  1000,  1001,  1002,
  1003,  1004,  1004,  1005,  1006,  1007,  1008,
  1008,  1009,  1010,  1011,  1011,  1012,  1013,
  1013,  1014,  1014,  1015,  1015,  1016,  1017,
  1017,  1017,  1018,  1018,  1019,  1019,  1020,
  1020,  1020,  1021,  1021,  1021,  1021,  1022,
  1022,  1022,  1022,  1022,  1023,  1023,  1023,
  1023,  1023,  1023,  1023,  1023,  1023,  1023,
  1023,  1023,  1023,  1023,  1023,  1022,  1022,
  1022,  1022,  1022,  1021,  1021,  1021,  1021,
  1020,  1020,  1020,  1019,  1019,  1018,  1018,
  1017,  1017,  1017,  1016,  1015,  1015,  1014,
  1014,  1013,  1013,  1012,  1011,  1011,  1010,
  1009,  1008,  1008,  1007,  1006,  1005,  1004,
  1004,  1003,  1002,  1001,  1000,   999,   998,
   997,   996,   995,   994,   993,   992,   991,
   990,   989,   988,   986,   985,   984,   983,
   982,   980,   979,   978,   977,   975,   974,
   973,   971,   970,   968,   967,   966,   964,
   963,   961,   960,   958,   957,   955,   953,
   952,   950,   949,   947,   945,   944,   942,
   940,   939,   937,   935,   933,   932,   930,
   928,   926,   924,   922,   921,   919,   917,
   915,   913,   911,   909,   907,   905,   903,
   901,   899,   897,   895,   893,   891,   889,
   886,   884,   882,   880,   878,   876,   873,
   871,   869,   867,   864,   862,   860,   857,
   855,   853,   850,   848,   846,   843,   841,
   839,   836,   834,   831,   829,   826,   824,
   821,   819,   816,   814,   811,   809,   806,
   804,   801,   798,   796,   793,   791,   788,
   785,   783,   780,   777,   775,   772,   769,
   767,   764,   761,   758,   756,   753,   750,
   747,   745,   742,   739,   736,   733,   730,
   728,   725,   722,   719,   716,   713,   710,
   708,   705,   702,   699,   696,   693,   690,
   687,   684,   681,   678,   675,   672,   669,
   666,   663,   660,   657,   654,   651,   648,
   645,   642,   639,   636,   633,   630,   627,
   624,   621,   618,   615,   612,   609,   606,
   602,   599,   596,   593,   590,   587,   584,
   581,   578,   575,   571,   568,   565,   562,
   559,   556,   553,   550,   546,   543,   540,
   537,   534,   531,   528,   525,   521,   518,
   515,   512,   509,   506,   503,   499,   496,
   493,   490,   487,   484,   481,   478,   474,
   471,   468,   465,   462,   459,   456,   453,
   449,   446,   443,   440,   437,   434,   431,
   428,   425,   422,   418,   415,   412,   409,
   406,   403,   400,   397,   394,   391,   388,
   385,   382,   379,   376,   373,   370,   367,
   364,   361,   358,   355,   352,   349,   346,
   343,   340,   337,   334,   331,   328,   325,
   322,   319,   316,   314,   311,   308,   305,
   302,   299,   296,   294,   291,   288,   285,
   282,   279,   277,   274,   271,   268,   266,
   263,   260,   257,   255,   252,   249,   247,
   244,   241,   239,   236,   233,   231,   228,
   226,   223,   220,   218,   215,   213,   210,
   208,   205,   203,   200,   198,   195,   193,
   190,   188,   185,   183,   181,   178,   176,
   174,   171,   169,   167,   164,   162,   160,
   157,   155,   153,   151,   148,   146,   144,
   142,   140,   138,   135,   133,   131,   129,
   127,   125,   123,   121,   119,   117,   115,
   113,   111,   109,   107,   105,   103,   102,
   100,    98,    96,    94,    92,    91,    89,
    87,    85,    84,    82,    80,    79,    77,
    75,    74,    72,    71,    69,    67,    66,
    64,    63,    61,    60,    58,    57,    56,
    54,    53,    51,    50,    49,    47,    46,
    45,    44,    42,    41,    40,    39,    38,
    36,    35,    34,    33,    32,    31,    30,
    29,    28,    27,    26,    25,    24,    23,
    22,    21,    20,    20,    19,    18,    17,
    16,    16,    15,    14,    13,    13,    12,
    11,    11,    10,    10,     9,     9,     8,
     7,     7,     7,     6,     6,     5,     5,
     4,     4,     4,     3,     3,     3,     3,
     2,     2,     2,     2,     2,     1,     1,
     1,     1,     1,     1,     1,     1,     1,
     1,     1,     1,     1,     1,     1,     2,
     2,     2,     2,     2,     3,     3,     3,
     3,     4,     4,     4,     5,     5,     6,
     6,     7,     7,     7,     8,     9,     9,
    10,    10,    11,    11,    12,    13,    13,
    14,    15,    16,    16,    17,    18,    19,
    20,    20,    21,    22,    23,    24,    25,
    26,    27,    28,    29,    30,    31,    32,
    33,    34,    35,    36,    38,    39,    40,
    41,    42,    44,    45,    46,    47,    49,
    50,    51,    53,    54,    56,    57,    58,
    60,    61,    63,    64,    66,    67,    69,
    71,    72,    74,    75,    77,    79,    80,
    82,    84,    85,    87,    89,    91,    92,
    94,    96,    98,   100,   102,   103,   105,
   107,   109,   111,   113,   115,   117,   119,
   121,   123,   125,   127,   129,   131,   133,
   135,   138,   140,   142,   144,   146,   148,
   151,   153,   155,   157,   160,   162,   164,
   167,   169,   171,   174,   176,   178,   181,
   183,   185,   188,   190,   193,   195,   198,
   200,   203,   205,   208,   210,   213,   215,
   218,   220,   223,   226,   228,   231,   233,
   236,   239,   241,   244,   247,   249,   252,
   255,   257,   260,   263,   266,   268,   271,
   274,   277,   279,   282,   285,   288,   291,
   294,   296,   299,   302,   305,   308,   311,
   314,   316,   319,   322,   325,   328,   331,
   334,   337,   340,   343,   346,   349,   352,
   355,   358,   361,   364,   367,   370,   373,
   376,   379,   382,   385,   388,   391,   394,
   397,   400,   403,   406,   409,   412,   415,
   418,   422,   425,   428,   431,   434,   437,
   440,   443,   446,   449,   453,   456,   459,
   462,   465,   468,   471,   474,   478,   481,
   484,   487,   490,   493,   496,   499,   503,
   506,   509 };



int transferSize = 511;

void initNoteSystem(void){
    for (int i = 0; i < sizeof(soundData)/sizeof(short); i++){
        soundData[i] = (soundData[i] << 6);
    }

    //Set P0.26 function to AOUT and mode to no pull resistors
    PINSEL[1] &= ~(3 << 20);
    PINMODE[1] &= (1 << 21);
    PINSEL[1] |= (1 << 21);

    //Set PCLK divider to 1 for DAC
    PCLKSEL0 |= (1 << 22);

    //Enable DMA Peripheral and enable DMA controller
    PCONP |= (1 << 29);
    DMACConfig |= 1;
    DMACC0.Config &= ~(1u);

    //Clear Interrupts for DMACC0
    DMACIntErrClr = 1;
    DMACIntTCClear = 1;

    //Set Source Address and Destination Address for DMA
    DMACC0.SrcAddr = (unsigned int) &soundData[0];
    DMACC0.DestAddr = (unsigned int) &DACR;

    //Configure LLI's
    LLI1.SrcAddr = (unsigned int) &soundData[0];
    LLI1.DestAddr = (unsigned int) &DACR;
    LLI1.LLI = (unsigned int) &LLI2;
    LLI1.Control = transferSize | (1 << 18) | (1 << 21) | (1 << 26);

    LLI2.SrcAddr = (unsigned int) &soundData[512];
    LLI2.DestAddr = (unsigned int) &DACR;
    LLI2.LLI = (unsigned int) &LLI1;
    LLI2.Control = transferSize | (1 << 18) | (1 << 21) | (1 << 26);

    //Set relevant settings for DMACC0
    DMACC0.Control = transferSize | (1 << 18) | (1 << 21) | (1 << 26);
    DMACC0.Config =
        (1) |       //Enable Ch0
        (7 << 6) |  //DAC Peripheral
        (1 << 11);  //Memory to Peripheral
	DMACC0.LLI = (unsigned int) &LLI1;

    //Enable DMA Channel 0
    DMACC0.Config |= 1;

    //Set DMA Counter for DAC
    DACCNTVAL = PCLK / SampleRate;

    //Enable DMA access and DMA counter
    DACCTRL |= (1 << 2) | (1 << 3);
}
